<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="charBoardMapper">

	<resultMap type="charBoard" id="charBoardResultSet">
		<result column="CB_NO" property="boardNo"/>
		<result column="C_NO" property="charNo"/>
		<result column="CB_WRITER" property="boardWriter"/>
		<result column="CB_TITLE" property="boardTitle"/>
		<result column="CB_CONTENT" property="boardContent"/>
		<result column="CB_VIEWS" property="views"/>
		<result column="CB_LIKE" property="like"/>
		<result column="CB_CREATE_DATE" property="createDate"/>
		<result column="CA_ORIGIN_NAME" property="originName"/>
		<result column="CA_CHANGE_NAME" property="changeName"/>
		<result column="CB_STATUS" property="status"/>
	</resultMap>
	
	<resultMap type="charAttach" id="charAttachResultSet">
		<result column="CA_NO" property="fileNo"/>
		<result column="CB_NO" property="refBno"/>
		<result column="CA_ORIGIN_NAME" property="originName"/>
		<result column="CA_CHANGE_NAME" property="changeName"/>
		<result column="CA_LEVEL" property="level"/>
		<result column="CA_CREATE_DATE" property="createDate"/>
		<result column="CA_STATUS" property="status"/>
	</resultMap>
	
	<!-- 게시글 조회수 증가 -->
	<update id="increaseCount" parameterType="_int">
		UPDATE TB_CHARACTER_BOARD
		SET CB_VIEWS = CB_VIEWS +1
		WHERE CB_NO = #{ bno }
		AND CB_STATUS = 'Y'
	</update>
	
	<!-- 게시글 상세 조회 -->
	<select id="selectBoard" resultMap="charBoardResultSet" parameterType="_int">
		SELECT CB_NO
			  ,CB_TITLE
		      ,CB_CONTENT
		      ,CB_CREATE_DATE
		      ,CA_ORIGIN_NAME
		      ,CA_CHANGE_NAME
		FROM TB_CHARACTER_BOARD
		JOIN TB_CHARACTER_ATTACH USING(CB_NO)
		WHERE CA_STATUS = 'Y'
		AND CB_NO = #{ bno }
	</select>
	
	<!-- 전체 개시글 수 반환 -->
	<select id="selectListCount" resultType="_int">
		SELECT COUNT(*)
		FROM TB_CHARACTER_BOARD
	</select>
	
	<!-- 게시글 리스트 조회 -->
	<select id="selectList" resultMap="charBoardResultSet">
		SELECT CB_NO
		      ,CB_WRITER
		      ,CB_TITLE
		      ,CB_CONTENT
		      ,CA_CHANGE_NAME
		      ,CB_VIEWS
		      ,CB_LIKE
		      ,CB_CREATE_DATE
		FROM TB_CHARACTER_BOARD
		JOIN TB_CHARACTER_ATTACH USING(CB_NO)
		WHERE CB_STATUS = 'Y'
		AND CA_STATUS = 'Y'
		AND CA_LEVEL = 1
		ORDER BY CB_CREATE_DATE DESC
	</select>
	
	<!-- 게시글 등록 (글) -->
	<insert id="insertBoard" parameterType="charBoard">
		INSERT INTO TB_CHARACTER_BOARD(
									   CB_NO
									  ,CB_TITLE
									  ,CB_CONTENT)
					VALUES(SEQ_CBNO.NEXTVAL
						  ,#{ boardTitle }
						  ,#{ boardContent })
	</insert>
	
	<!-- 게시글 등록 (첨부파일) -->
	<insert id="insertAttach" parameterType="java.util.List">
		INSERT INTO TB_CHARACTER_ATTACH(
									    CA_NO
									   ,CB_NO
									   ,CA_ORIGIN_NAME
									   ,CA_CHANGE_NAME
									   ,CA_LEVEL)
		SELECT SEQ_CANO.NEXTVAL,SEQ_CBNO.CURRVAL, A.*
		FROM(
			 <foreach collection="list" item="item" index="index" separator="union all">
			 		SELECT #{ item.originName }
			 			  ,#{ item.changeName }
			 			  ,#{ item.level }
			 		FROM SYS.DUAL
			 </foreach>
			 )A
	</insert>
	
	<!-- 게시글 수정 -->
	<update id="updateBoard" parameterType="charBoard">
		UPDATE TB_CHARACTER_BOARD
		SET CB_TITLE = #{ boardTitle },
			CB_CONTENT = #{ boardContent }
		WHERE CB_STATUS = 'Y'
	</update>
	<!-- 첨부파일 수정 -->
	<update id="updateAttach" parameterType="charBoard">
		UPDATE TB_CHARACTER_ATTACH
		SET CA_ORIGIN_NAME = #{ originName },
			CA_CHANGE_NAME = #{ changeName }
		WHERE CA_STATUS = 'Y'
	</update>
	
	<!-- 게시글 삭제 -->
	<update id="deleteBoard" parameterType="_int">
		UPDATE TB_CHARACTER_BOARD
		SET CB_STATUS = 'N'
		WHERE CB_NO = #{ bno }
	</update>
	<!-- 게시글 첨부파일 삭제 -->
	<update id="deleteAttach" parameterType="_int">
		UPDATE TB_CHARACTER_ATTACH
		SET CA_STATUS = 'N'
		WHERE CB_NO = #{ bno }
	</update>

</mapper>